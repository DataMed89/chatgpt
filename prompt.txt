
écris moi un code pour un algorithme de trading automatique sur Tradingview qui va utiliser la classification de LORENTZIAN
en combinant les 7 dimensions suivantes :
1) Liquidité
2) Prix
3) Volume
4) Temps
5) Momentum
6) Volatilité
7) Valeur


VAR CurrUser = USERPRINCIPALNAME()

VAR PTFListGAD =
    CALCULATETABLE (
        VALUES ( a2posecuriteagent ),
        FILTER ( ALLSELECTED ( a2posecuriteagent ), [EMAIL_GAD] = CurrUser )
    )

VAR PTFListAXA =
    CALCULATETABLE (
        VALUES ( a2posecuriteagent[PTF_ID] ),
        FILTER ( ALLSELECTED ( a2posecuriteagent ), [EMAIL_AXA] = CurrUser )
    )

VAR PTFList = UNION (PTFListGAD,PTFListAXA)
 
 return
[EMAIL_GAD] = USERPRINCIPALNAME() || [EMAIL_AXA] = USERPRINCIPALNAME()


En tant qu'expert en power bi et en RLS, je veux que tu m'aides à développer les bonnes RLS pour le modèle suivant ;

Table transactionnelle :bv_a2p qui contient les colonnes suivantes : annee, numéro_contrat, etc...
d'autres tables dimentionnelles comme calendrier, dim_contrat, etc... comme tu peux le voir sur le schéma

j'ai des tables RLS :
 DIM_AGENT qui a une relation de 1 à n avec la table a2posecuriteagent ( qui contient les données importantes EMAIl_GAD,ID_PTF (identifiant portefeuille))

a2posecuriteagent qui filtre securite_contrat de * à * via la clé identifiant portefeuille ( car un contrat peut être par plusieurs agents..)
a2posecuriteagent qui filtre en double directionnel la table DIM_PORTEFEUILLE (* à 1)  : j'ai mis la dim_portefeuille pour pouvoir mettre un filtre portfeuille sur mon rapport de manière à ce que les agents ne puissent filtrer que sur leurs portfeuilles


securite_contrat filtre 1 à * la table transactionnelle bv_a2p via la clé numéro_contrat

securite_contrat  filtre aussi dim_client en bidirectionnel entre de * à 1 via la clé personne afin d'avoir par la suite un filtre Client pour que l'agent filtre ses client



Mais le problème c'est que les RLS ne fonctionnent pas quand je les parametre (voir l'image)
############################################################################################################
#######################################################################################################################

Sachant que la colonne montant_mouvement, est de type nombre décimal 
j'aimerais que les mesures suivantes m'affichent des nombres entiers complets au lieu d'afficher des nombres comme 35K , je veux 35767 eur (avec signe euros)
il faut aussi tenir compte  qu'il y a une mesure qui est la somme des deux autres que tu verras dans le dax code donc à à prendre en compte pour la stratégie globale

1 ere mesure (nom fonctionnel Encours) :
PM_FIN_ANNEE_FILTER = 

VAR HasYearFilter   = ISFILTERED ( 'Calendrier'[Année] )

VAR TodayDate       = [Endate]

VAR StartDefault    = [Startdate]

/* 1) Dernière date de 'PM FIN ANNEE' selon le mode */

VAR LastPMDate =

  
        CALCULATE (

            MAX ( 'bv_a2p'[date_de_valorisation] ),

            KEEPFILTERS ( 'bv_a2p'[type_mouvement] = "PM FIN ANNEE" )

        )

/* 2) Somme des seules PM de cette dernière date */

RETURN

IF (

    NOT ISBLANK ( LastPMDate ),

    CALCULATE (

        SUM ( 'bv_a2p'[montant_mouvement] ),

        'bv_a2p'[type_mouvement] = "PM FIN ANNEE",

        'bv_a2p'[date_de_valorisation] = LastPMDate

    )

)

2ème mesure (nom fonctionnel : Versements nets)
TOTAL_VERSEMENTS_FILTER = 

VAR StartDate     = DATE([Startdate],1,1)
VAR EndDate     = DATE ([Endate],12,31 )

VAR Result = 
-SUMX ( 
    FILTER('bv_a2p',
    ('bv_a2p'[montant_mouvement] < 0 
    && bv_a2p[type_mouvement] = "VERSEMENT" 
    && bv_a2p[date_de_valorisation] >= StartDate 
    && bv_a2p[date_de_valorisation] <= EndDate )
    ) , 'bv_a2p'[montant_mouvement] )
RETURN 
IF(Result == BLANK(), 0,Result)
3ème mesure (Rachats brut)
TOTAL_RETRAIT_FILTER = 
VAR StartDate     = DATE([Startdate],1,1)
VAR EndDate     = DATE ([Endate],12,31 )


VAR  RESULT = SUMX (
     FILTER('bv_a2p',
      'bv_a2p'[montant_mouvement] > 0
      && bv_a2p[type_mouvement] = "RACHAT" && 
      'bv_a2p'[date_de_valorisation] >= StartDate &&
       'bv_a2p'[date_de_valorisation] <= EndDate),
      'bv_a2p'[montant_mouvement])
RETURN
IF (RESULT ==BLANK(), 0, RESULT)

4ème mesure (somme des deux autres, nom somme des mouvements
[TOTAL_VERSEMENTS_FILTER] - [TOTAL_RETRAIT_FILTER]

###########################################################################################################################################################################
############################################################################################################################################################################
Je voudrais que tu prennes le double rôle d'un expert en actuariat et en Data 
Sachant que le projet en cours est un projet de BI pour calculer les indicateurs de la performance d'un portefeuille client sur les produits assurance vie ( Versements, Rachats, TRI (taux de rendement interne) etc...)
Voici le fichier excel issu d'un atelier avec le métier pour catégoriser les actes(flux) en flux sortant, fluant entrant, et savoir si oui ou non ces actes rentrent dans le calcul de la PM (provision mathématique)

La première colonne contient le code acte (exemple AB, CD, CR etc...)
deuxième colonne c'est le libellé du code acte (que j'aimerais que tu comprennes bienà
Troisième colonne : 
Quand tu trouves : Flux sortant calcul PM , cela veut dire que cet acte est considéré comme un flux sortant et qu'il entre dans le calcul de la PM
Quand tu trouves : FLux entrant calcul PM, cela veut dire que cet acte est considéré comme un flux entrant et qu'il entre en jeux dans le calcul de la PM
quand tu trouves : Mnt versement + Flux entrant calcul PM : cela veut dire que cet acte intervient dans le calcul du versement + considéré comme flux entrant et entre en jeux dans le calcul de la PM
Quand tu trouves : Mnt Rachat + Flux sortant Calcul PM , cela veut dire que cet acte est utilisé dans le calcul du Rachat + le calcul de la PM 

etc....ainsi tu comprendras la suite logique
NB --> Ne prends pas en compte les  actes dont les libellés sont "Annulation déjà pris en compte" et "Ne pas pas prendre en compte"

Maintenant le problème est le suivant :
sachant que dans notre jargon , on a des flux entrants et sortants( exemple Versements doivent être vus comme flux entrants, Rachats comme flux sortant)
je pense que le fichier Excel que je t'ai donné contient des erreurs quant à la qualification des actes et aimerais que tu sois force de proposition en indentifiant les erreus .
Ta méthodologie doit être la suivante :
pour un code acte X : réexpliquer sa définition, à quoi il sert et expliquer par une petite démo logique (ou même mathématique ) pourquoi il doit être considéré comme sortant ou entrant  etc...
et à la fin que tu produise un fichier au même format que je t'ai donné avec les corrections prises en compte
Merci infinimment You are the best 

#######################################################

3. Ligne 39 – Code SD – “Solde à une date”
• Ancien : Flux entrant Calcul PM
• Nouveau  (proposition) : Ne pas prendre en compte
• Pourquoi : ce n’est pas un flux mais un stock / snapshot (valeur de PM à une date).
• Exemple : “PM = 12 345€” n’est pas une transaction, donc ne doit pas entrer dans les sommes de flux.
4. Ligne 40 – Code SE – “Sans effet”
• Ancien : Flux sortant Calcul PM
• Nouveau  (proposition) : Ne pas prendre en compte
• Pourquoi : par définition, l’acte n’a pas d’impact financier (sinon il ne serait pas “sans effet”).

5. Ligne 41 – Code SI – “Sinistre”
• Ancien : Mnt Rachat + Flux sortant Calcul PM
• Nouveau : Flux sortant Calcul PM (mais pas rachat)
• Pourquoi : un sinistre (décès, etc.) est une prestation / règlement assuré-bénéficiaire, ce n’est pas un rachat.
• Exemple : PM=15 000€, sinistre payé 10000€ ⇒ PM=5000 (sortant PM), mais indicateur “rachat” ne doit pas être alimenté.

6. Ligne 43 – Code VE – “Virement de réserve en entrée”
• Ancien : Mnt Versement + Flux entrant Calcul PM
• Nouveau : Flux entrant Calcul PM (mais pas versement)
• Pourquoi : c’est typiquement une reclasse interne (ex : réserve/PPB/PPE vers PM), pas un paiement client.
• Exemple : PM=10 000€, “virement réserve” +200€ ⇒ PM=10 200€ sans versement client.

7. Ligne 45 – Code VP – “Transfert de cotisations”
• Ancien : Mnt Versement + Flux entrant Calcul PM
• Nouveau (proposition) : Flux entrant Calcul PM (mais pas versement)
• Pourquoi : un transfert est souvent une migration / transfert interne (contrat à contrat). Ce n’est pas du “new money”.
• Exemple portefeuille : Contrat A -5 000€, Contrat B +5 000€ ⇒ net 0 au niveau client.

8. Ligne 33 – Code RE – “Résiliation”
• Ancien : Flux sortant Calcul PM
• Nouveau (proposition) : Mnt Rachat + Flux sortant Calcul PM
• Pourquoi : sur épargne, une résiliation aboutit généralement à une sortie de valeur (équivalent rachat total).
• Exemple : PM=8 000€, résiliation avec paiement 8 000€ ⇒ PM=0 (et ça alimente “rachats”).

9. Ligne 35 – Code RN – “Renonciation”
• Ancien : Flux sortant Calcul PM
• Nouveau (proposition) : Mnt Rachat + Flux sortant Calcul PM


 






